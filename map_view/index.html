<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>Google Maps API V3 lesson 1</title>
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map { height: 100% }
    </style>
    <script type="text/javascript">
        var map, geocoder, infowindow;
        
        function get_data(){
            url = "http://localhost:8000/get_data";
            console.log("get_data()");
            fetch(url)
                .then(function(response) {
                    if (!response.ok) {
                        console.log("Not cool.");
                        console.log(response);
                        return new Error(response);
                    }
                    console.log("Got response");
                    //console.log(response)
                    return response.json();
                })
                .then(function(jsonResponse) {
                    //console.log(jsonResponse);
                    initialize(jsonResponse);
                });
        }

        function initialize(allApts) {
            console.log("initialize()");
            console.log(allApts);
            var arrDestinations = [
            ];
            for (var i = 0; i < allApts.length; i++) {
                if (allApts[i].hasOwnProperty("coords")) {
                    var apt = allApts[i];
                    var description = `Velaton hinta: ${apt["price_total"]}e<br/>
                                       Fiilis: ${apt["fiilis"]}/5, Kunto: ${apt["kunto"]}/5`;
                    var apt_pin = {
                        lat: allApts[i]["coords"][0],
                        lon: allApts[i]["coords"][1],
                        title:  allApts[i]["address"],
                        description:  description
                    };
                    arrDestinations.push(apt_pin);
                }
            }
            var myOptions = {
                zoom: 10,
                center: new google.maps.LatLng(61.4978, 23.7610),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            
            map = new google.maps.Map(document.getElementById("map"), myOptions);
            
            geocoder = new google.maps.Geocoder();
            
            var infowindow =  new google.maps.InfoWindow({
                content: ''
            });
            // loop over our array
            for (i = 0; i < arrDestinations.length; i++) {
                // create a marker
                var marker = new google.maps.Marker({
                    title: arrDestinations[i].title,
                    position: new google.maps.LatLng(arrDestinations[i].lat, arrDestinations[i].lon),
                    map: map
                });
                
                // add an event listener for this marker
                bindInfoWindow(marker, map, infowindow, "<p>" + arrDestinations[i].description + "</p>");  
            }
        
        }
        function bindInfoWindow(marker, map, infowindow, html) { 
            google.maps.event.addListener(marker, 'click', function() { 
                infowindow.setContent(html); 
                infowindow.open(map, marker); 
            }); 
        } 
        

        
        
        </script>
        <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBR7549cMRuxeIS1d1sCG4_wpLGJj99CsA&callback=get_data">
        </script>
</head>
<body>
<h1>Hey, there's supposed to be a map below</h1>
<div id="map"></div>
</body>
</html>

